#!/bin/sh

# Mount essential filesystems
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev

# Parse machine_id from /proc/cmdline
if [ -e /proc/cmdline ]; then
    MACHINE_ID=$(awk -F'machine_id=' '{if (NF>1) print $2}' /proc/cmdline | awk '{print $1}')
    if [ -n "$MACHINE_ID" ] && [ "$MACHINE_ID" != "10000000000000000000000000000001" ]; then
        echo "$MACHINE_ID" > /etc/machine-id
        chmod 0444 /etc/machine-id
    fi
    if grep -q /proc/cmdline -e quiet; then
	clear
    fi
fi
# Input file where capabilities are stored
CAP_FILE="/etc/filecaps"

# Read each line in the CAP_FILE
while IFS= read -r line; do
    # Extract the file path and capability string using parameter expansion
    file_path="${line% *}"  # Everything before the last space
    caps="${line##* }"      # Everything after the last space

    # Apply the capabilities to the file if the file exists
    if [ -n "$caps" ] && [ -e "$file_path" ]; then
        setcap "$caps" "$file_path"
    fi
done < "$CAP_FILE"

# Hand over control to systemd
exec /lib64/systemd/systemd
