#!/bin/sh

. `dirname $0`/common

nft flush ruleset
echo 0 > /proc/sys/net/ipv4/ip_forward
echo 0 > /proc/sys/net/ipv6/conf/all/forwarding

# Create table and chains for dual-stack (IPv4 and IPv6)
nft add table inet filter

nft add chain inet filter INPUT '{ type filter hook input priority 0; policy drop; }'
nft add chain inet filter FORWARD '{ type filter hook forward priority 0; policy drop; }'
nft add chain inet filter OUTPUT '{ type filter hook output priority 0; policy accept; }'

# Add rules for loopback and connection tracking (IPv4 and IPv6)
nft add rule inet filter INPUT iif "lo" accept
nft add rule inet filter INPUT ct state established,related accept

# Allow ICMP echo requests (ping) for IPv4 and IPv6
if is_enabled "$FIREWALL_PING"; then
    nft add rule inet filter INPUT ip protocol icmp icmp type echo-request accept
    nft add rule inet filter INPUT icmpv6 type echo-request accept
fi

# Load additional rules for IPv4 and IPv6
for rule in `ls /etc/nftables/nftables.d/`; do
    . /etc/nftables/nftables.d/$rule
done
